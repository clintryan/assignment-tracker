<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Assignment Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Student Assignment Tracker</h1>
            <p class="text-gray-600 mt-1">A clear and simple view of assignment status for students.</p>
        </header>

        <div class="bg-white rounded-lg shadow-md p-6">
            <!-- Controls -->
            <div class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between">
                <div class="flex items-center space-x-3">
                    <label for="class-selector" class="font-medium text-gray-700">Select a Class:</label>
                    <select id="class-selector" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="7gh-ela">7GH ELA</option>
                        <option value="7gh-ss">7GH Social Studies</option>
                        <option value="7ab-ela">7AB ELA</option>
                        <option value="7ab-ss">7AB Social Studies</option>
                    </select>
                </div>
                <div id="legend" class="mt-4 sm:mt-0 flex flex-wrap gap-x-4 gap-y-2">
                    <!-- Legend will be populated by JS -->
                </div>
            </div>

            <!-- Compact Dashboard -->
            <div class="mb-6 bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Class Overview</h3>
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Left side: Stats (1/3) -->
                    <div class="w-full lg:w-1/3">
                        <div class="space-y-3">
                            <div class="flex items-center justify-between py-2 px-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-blue-500 rounded-full mr-3"></div>
                                    <span class="text-sm font-medium text-gray-700">Total Assignments</span>
                                </div>
                                <span class="text-lg font-semibold text-gray-900" id="total-assignments">—</span>
                            </div>
                            
                            <div class="flex items-center justify-between py-2 px-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                    <span class="text-sm font-medium text-gray-700">Completion Rate</span>
                                </div>
                                <span class="text-lg font-semibold text-gray-900" id="completion-rate">—</span>
                            </div>
                            
                            <div class="flex items-center justify-between py-2 px-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-red-500 rounded-full mr-3"></div>
                                    <span class="text-sm font-medium text-gray-700">Incomplete/Missing</span>
                                </div>
                                <span class="text-lg font-semibold text-gray-900" id="incomplete-percentage">—</span>
                            </div>
                            
                            <div class="py-2 px-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center mb-1">
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full mr-3"></div>
                                    <span class="text-sm font-medium text-gray-700">Most Problematic</span>
                                </div>
                                <div class="text-sm text-gray-600 ml-6" id="problematic-assignment">—</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right side: Pie Chart (2/3) -->
                    <div class="w-full lg:w-2/3 flex justify-center">
                        <div class="relative">
                            <canvas id="statusPieChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table Container -->
            <div class="overflow-x-auto">
                <div id="table-container">
                    <!-- Table will be dynamically generated here -->
                </div>
            </div>
        </div>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Generated on <span id="generation-date"></span></p>
        </footer>

    </div>

    <script>
        // Google Sheets CSV URLs
        const csvUrls = {
            '7gh-ela': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQfw36kO4YEhF1HLozChrNPcvXKg0c0RNXJ5WWwhCr62i9mkauiTT2v4JpOg1gECZEteySNmAPyzxR8/pub?gid=1302331666&single=true&output=csv',
            '7gh-ss': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQfw36kO4YEhF1HLozChrNPcvXKg0c0RNXJ5WWwhCr62i9mkauiTT2v4JpOg1gECZEteySNmAPyzxR8/pub?gid=632874045&single=true&output=csv',
            '7ab-ela': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQfw36kO4YEhF1HLozChrNPcvXKg0c0RNXJ5WWwhCr62i9mkauiTT2v4JpOg1gECZEteySNmAPyzxR8/pub?gid=73834669&single=true&output=csv',
            '7ab-ss': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQfw36kO4YEhF1HLozChrNPcvXKg0c0RNXJ5WWwhCr62i9mkauiTT2v4JpOg1gECZEteySNmAPyzxR8/pub?gid=162306615&single=true&output=csv'
        };

        // Cache for CSV data to avoid repeated fetches
        const csvDataCache = {};

        const statusMap = {
            'c': { text: 'Complete', color: 'green', icon: 'M12.75 15l3-3m0 0l-3-3m3 3h-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
            'e': { text: 'Excellent!', color: 'blue', icon: 'M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z' },
            'i': { text: 'Incomplete', color: 'yellow', icon: 'M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z' },
            'm': { text: 'Missing', color: 'red', icon: 'M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z' }
        };
        
        const colorClasses = {
            green: { bg: 'bg-green-100', text: 'text-green-800', icon: 'text-green-500' },
            blue: { bg: 'bg-blue-100', text: 'text-blue-800', icon: 'text-blue-500' },
            yellow: { bg: 'bg-yellow-100', text: 'text-yellow-800', icon: 'text-yellow-500' },
            red: { bg: 'bg-red-100', text: 'text-red-800', icon: 'text-red-500' },
            gray: { bg: 'bg-gray-100', text: 'text-gray-800', icon: 'text-gray-500' },
        }

        // Function to fetch CSV data from Google Sheets
        async function fetchCsvData(classKey) {
            // Return cached data if available
            if (csvDataCache[classKey]) {
                return csvDataCache[classKey];
            }

            try {
                const response = await fetch(csvUrls[classKey]);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                
                // Cache the data
                csvDataCache[classKey] = csvText;
                return csvText;
            } catch (error) {
                console.error('Error fetching CSV data:', error);
                // Show error message to user
                document.getElementById('table-container').innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-600 mb-2">⚠️ Error loading data</div>
                        <div class="text-sm text-gray-500">Unable to fetch data from Google Sheets. Please check your internet connection and try again.</div>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Retry
                        </button>
                    </div>
                `;
                return null;
            }
        }

        // Function to show loading state
        function showLoadingState() {
            document.getElementById('table-container').innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <div class="mt-2 text-gray-600">Loading data from Google Sheets...</div>
                </div>
            `;
            
            // Reset stats during loading
            document.getElementById('completion-rate').textContent = '—';
            document.getElementById('incomplete-percentage').textContent = '—';
            document.getElementById('total-assignments').textContent = '—';
            document.getElementById('problematic-assignment').textContent = '—';
        }

        // Function to calculate and display statistics
        function calculateAndDisplayStats(lines, assignmentHeaders) {
            const studentData = lines.slice(2);
            const totalStudents = studentData.filter(line => line.split(',')[0].trim()).length;
            const totalAssignments = assignmentHeaders.length;
            
            if (totalStudents === 0 || totalAssignments === 0) {
                // Reset stats if no data
                document.getElementById('completion-rate').textContent = '—';
                document.getElementById('incomplete-percentage').textContent = '—';
                document.getElementById('total-assignments').textContent = '—';
                document.getElementById('problematic-assignment').textContent = '—';
                return;
            }

            // Calculate completion statistics
            let totalAssignmentsWithData = 0;
            let actualCompletions = 0; // C + E
            let actualIncomplete = 0;  // M + I
            let assignmentMissingCounts = new Array(totalAssignments).fill(0);

            studentData.forEach(line => {
                const columns = line.split(',');
                const studentName = columns[0].trim();
                if (!studentName) return;
                
                assignmentHeaders.forEach((_, index) => {
                    const statusKey = (columns[index + 1] || '').trim();
                    
                    // Only count cells that have actual data (not empty)
                    if (statusKey) {
                        totalAssignmentsWithData++;
                        
                        if (statusKey === 'c' || statusKey === 'e') {
                            actualCompletions++;
                        } else if (statusKey === 'm' || statusKey === 'i') {
                            actualIncomplete++;
                            if (statusKey === 'm') {
                                assignmentMissingCounts[index]++;
                            }
                        }
                    }
                });
            });

            // Calculate completion rate: (C + E) / (C + E + M + I) × 100%
            const completionRate = totalAssignmentsWithData > 0 
                ? Math.round((actualCompletions / totalAssignmentsWithData) * 100) 
                : 0;

            // Calculate incomplete/missing percentage: (M + I) / (C + E + M + I) × 100%
            const incompletePercentage = totalAssignmentsWithData > 0 
                ? Math.round((actualIncomplete / totalAssignmentsWithData) * 100) 
                : 0;

            // Find most problematic assignment
            let maxMissing = 0;
            let problematicAssignmentIndex = 0;
            assignmentMissingCounts.forEach((count, index) => {
                if (count > maxMissing) {
                    maxMissing = count;
                    problematicAssignmentIndex = index;
                }
            });

            const problematicAssignment = maxMissing > 0 
                ? assignmentHeaders[problematicAssignmentIndex].trim()
                : 'None';

            // Update the stats display
            document.getElementById('completion-rate').textContent = `${completionRate}%`;
            document.getElementById('incomplete-percentage').textContent = `${incompletePercentage}%`;
            document.getElementById('total-assignments').textContent = totalAssignments.toString();
            document.getElementById('problematic-assignment').textContent = problematicAssignment;
            
            // Update pie chart
            updatePieChart(lines, assignmentHeaders);
        }

        // Global variable to store the chart instance
        let statusChart = null;

        // Register the datalabels plugin
        Chart.register(ChartDataLabels);

        // Function to update the pie chart
        function updatePieChart(lines, assignmentHeaders) {
            const studentData = lines.slice(2);
            
            // Count status occurrences
            const statusCounts = {
                'c': 0,
                'e': 0,
                'i': 0,
                'm': 0,
                'empty': 0
            };

            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded');
                return;
            }

            studentData.forEach(line => {
                const columns = line.split(',');
                const studentName = columns[0].trim();
                if (!studentName) return;

                assignmentHeaders.forEach((_, index) => {
                    const statusKey = (columns[index + 1] || '').trim();
                    if (statusKey && statusCounts.hasOwnProperty(statusKey)) {
                        statusCounts[statusKey]++;
                    } else if (!statusKey) {
                        statusCounts.empty++;
                    }
                });
            });

            // Prepare chart data
            const chartData = [];
            const chartLabels = [];
            const chartColors = [];
            const chartHoverColors = [];

            // Add data for each status (excluding empty)
            Object.keys(statusCounts).forEach(status => {
                if (status !== 'empty' && statusCounts[status] > 0) {
                    const statusInfo = statusMap[status];
                    chartLabels.push(statusInfo.text);
                    chartData.push(statusCounts[status]);
                    chartColors.push(getColorValue(statusInfo.color));
                    chartHoverColors.push(getHoverColorValue(statusInfo.color));
                }
            });

            // Don't include empty cells in the pie chart - they represent unassigned work
            // If no data, show a message
            if (chartData.length === 0) {
                chartLabels.push('No Data');
                chartData.push(1);
                chartColors.push('#E5E7EB');
                chartHoverColors.push('#D1D5DB');
            }

            // Destroy existing chart if it exists
            if (statusChart) {
                statusChart.destroy();
            }

            // Create new chart
            const ctx = document.getElementById('statusPieChart').getContext('2d');
            console.log('Creating pie chart with data:', chartData, 'labels:', chartLabels);
            statusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartData,
                        backgroundColor: chartColors,
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        hoverBackgroundColor: chartHoverColors,
                        hoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        animateRotate: true,
                        animateScale: true
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        datalabels: {
                            display: true,
                            color: 'white',
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            formatter: function(value, context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(0);
                                return percentage + '%';
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Helper function to get color values
        function getColorValue(colorName) {
            const colorMap = {
                'green': '#10B981',   // emerald-500
                'blue': '#3B82F6',    // blue-500
                'yellow': '#F59E0B',  // amber-500
                'red': '#EF4444'      // red-500
            };
            return colorMap[colorName] || '#6B7280';
        }

        // Helper function to get hover color values
        function getHoverColorValue(colorName) {
            const colorMap = {
                'green': '#059669',   // emerald-600
                'blue': '#2563EB',    // blue-600
                'yellow': '#D97706',  // amber-600
                'red': '#DC2626'      // red-600
            };
            return colorMap[colorName] || '#4B5563';
        }

        async function parseAndRender() {
            const selector = document.getElementById('class-selector');
            const selectedValue = selector.value;
            
            // Show loading state
            showLoadingState();
            
            // Fetch data from Google Sheets
            const rawData = await fetchCsvData(selectedValue);
            if (!rawData) return;

            const lines = rawData.trim().split('\n');
            const assignmentHeaders = lines[0].split(',').slice(1);
            const dateHeaders = lines[1].split(',').slice(1);
            const studentData = lines.slice(2);

            let tableHTML = `<table class="min-w-full divide-y divide-gray-200">`;

            // Table Head
            tableHTML += `<thead class="bg-gray-50"><tr>`;
            tableHTML += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>`;
            assignmentHeaders.forEach((header, index) => {
                tableHTML += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    <div>${header.trim()}</div>
                    <div class="font-normal text-gray-400">${dateHeaders[index] ? dateHeaders[index].trim() : ''}</div>
                </th>`;
            });
            tableHTML += `</tr></thead>`;

            // Table Body
            tableHTML += `<tbody class="bg-white divide-y divide-gray-200">`;
            studentData.forEach(line => {
                const columns = line.split(',');
                const studentName = columns[0].trim();
                if (!studentName) return; // Skip empty lines

                tableHTML += `<tr>`;
                tableHTML += `<td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${studentName}</td>`;
                
                assignmentHeaders.forEach((_, index) => {
                    const statusKey = (columns[index + 1] || '').trim();
                    
                    // Handle empty cells - show empty cell instead of "Missing"
                    if (!statusKey) {
                        tableHTML += `<td class="px-6 py-4 whitespace-nowrap text-gray-400">—</td>`;
                        return;
                    }
                    
                    const status = statusMap[statusKey] || { text: 'Unknown', color: 'gray', icon: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 15.5c-.77.833.192 2.5 1.732 2.5z' };
                    const colors = colorClasses[status.color];

                    tableHTML += `<td class="px-6 py-4 whitespace-nowrap">`;
                    tableHTML += `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${colors.bg} ${colors.text}">`;
                    tableHTML += `<svg class="w-5 h-5 mr-2 ${colors.icon}" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="${status.icon}"></path></svg>`;
                    tableHTML += status.text;
                    tableHTML += `</span></td>`;
                });

                tableHTML += `</tr>`;
            });
            tableHTML += `</tbody></table>`;

            document.getElementById('table-container').innerHTML = tableHTML;
            
            // Calculate and display statistics
            calculateAndDisplayStats(lines, assignmentHeaders);
        }
        
        function populateLegend() {
            const legendContainer = document.getElementById('legend');
            const displayedStatuses = new Set();
            let legendHTML = '';

            Object.values(statusMap).forEach(status => {
                if (status.text === 'Missing' && displayedStatuses.has('Missing')) return;

                const colors = colorClasses[status.color];
                legendHTML += `
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-1.5 ${colors.icon}" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="${status.icon}"></path></svg>
                        <span class="text-sm text-gray-600">${status.text}</span>
                    </div>`;
                displayedStatuses.add(status.text);
            });
            legendContainer.innerHTML = legendHTML;
        }


        document.addEventListener('DOMContentLoaded', async () => {
            const selector = document.getElementById('class-selector');
            selector.addEventListener('change', parseAndRender);
            
            // Set generation date
            document.getElementById('generation-date').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });

            // Initial render
            await parseAndRender();
            populateLegend();
        });

    </script>
</body>
</html>
