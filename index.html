<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Assignment Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Student Assignment Tracker</h1>
            <p class="text-gray-600 mt-1">A clear and simple view of assignment status for students.</p>
        </header>

        <div class="bg-white rounded-lg shadow-md p-6">
            <!-- Controls -->
            <div class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between">
                <div class="flex items-center space-x-3">
                    <label for="class-selector" class="font-medium text-gray-700">Select a Class:</label>
                    <select id="class-selector" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="7gh-ela">7GH ELA</option>
                        <option value="7gh-ss">7GH Social Studies</option>
                        <option value="7ab-ela">7AB ELA</option>
                        <option value="7ab-ss">7AB Social Studies</option>
                    </select>
                </div>
                <div id="legend" class="mt-4 sm:mt-0 flex flex-wrap gap-x-4 gap-y-2">
                    <!-- Legend will be populated by JS -->
                </div>
            </div>

            <!-- Stats Dashboard -->
            <div id="stats-dashboard" class="mb-6 bg-gray-50 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Class Statistics</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Completion Rate</p>
                                <p class="text-2xl font-semibold text-gray-900" id="completion-rate">—</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Students with Missing Work</p>
                                <p class="text-2xl font-semibold text-gray-900" id="missing-students">—</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Total Assignments</p>
                                <p class="text-2xl font-semibold text-gray-900" id="total-assignments">—</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Most Problematic Assignment</p>
                                <p class="text-sm font-semibold text-gray-900" id="problematic-assignment">—</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table Container -->
            <div class="overflow-x-auto">
                <div id="table-container">
                    <!-- Table will be dynamically generated here -->
                </div>
            </div>
        </div>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Generated on <span id="generation-date"></span></p>
        </footer>

    </div>

    <script>
        // Google Sheets CSV URLs
        const csvUrls = {
            '7gh-ela': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQfw36kO4YEhF1HLozChrNPcvXKg0c0RNXJ5WWwhCr62i9mkauiTT2v4JpOg1gECZEteySNmAPyzxR8/pub?gid=1302331666&single=true&output=csv',
            '7gh-ss': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQfw36kO4YEhF1HLozChrNPcvXKg0c0RNXJ5WWwhCr62i9mkauiTT2v4JpOg1gECZEteySNmAPyzxR8/pub?gid=632874045&single=true&output=csv',
            '7ab-ela': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQfw36kO4YEhF1HLozChrNPcvXKg0c0RNXJ5WWwhCr62i9mkauiTT2v4JpOg1gECZEteySNmAPyzxR8/pub?gid=73834669&single=true&output=csv',
            '7ab-ss': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQfw36kO4YEhF1HLozChrNPcvXKg0c0RNXJ5WWwhCr62i9mkauiTT2v4JpOg1gECZEteySNmAPyzxR8/pub?gid=162306615&single=true&output=csv'
        };

        // Cache for CSV data to avoid repeated fetches
        const csvDataCache = {};

        const statusMap = {
            'c': { text: 'Complete', color: 'green', icon: 'M12.75 15l3-3m0 0l-3-3m3 3h-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
            'e': { text: 'Exempt', color: 'gray', icon: 'M18 12H6' },
            'i': { text: 'Incomplete', color: 'yellow', icon: 'M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z' },
            'm': { text: 'Missing', color: 'red', icon: 'M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
            'AS': { text: 'At Standard', color: 'green', icon: 'M12.75 15l3-3m0 0l-3-3m3 3h-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
            'MS': { text: 'Meets Standard', color: 'green', icon: 'M12.75 15l3-3m0 0l-3-3m3 3h-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
            'BS': { text: 'Below Standard', color: 'yellow', icon: 'M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z' },
            'default': { text: 'Missing', color: 'red', icon: 'M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z' }
        };
        
        const colorClasses = {
            green: { bg: 'bg-green-100', text: 'text-green-800', icon: 'text-green-500' },
            yellow: { bg: 'bg-yellow-100', text: 'text-yellow-800', icon: 'text-yellow-500' },
            red: { bg: 'bg-red-100', text: 'text-red-800', icon: 'text-red-500' },
            gray: { bg: 'bg-gray-100', text: 'text-gray-800', icon: 'text-gray-500' },
        }

        // Function to fetch CSV data from Google Sheets
        async function fetchCsvData(classKey) {
            // Return cached data if available
            if (csvDataCache[classKey]) {
                return csvDataCache[classKey];
            }

            try {
                const response = await fetch(csvUrls[classKey]);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                
                // Cache the data
                csvDataCache[classKey] = csvText;
                return csvText;
            } catch (error) {
                console.error('Error fetching CSV data:', error);
                // Show error message to user
                document.getElementById('table-container').innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-600 mb-2">⚠️ Error loading data</div>
                        <div class="text-sm text-gray-500">Unable to fetch data from Google Sheets. Please check your internet connection and try again.</div>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Retry
                        </button>
                    </div>
                `;
                return null;
            }
        }

        // Function to show loading state
        function showLoadingState() {
            document.getElementById('table-container').innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <div class="mt-2 text-gray-600">Loading data from Google Sheets...</div>
                </div>
            `;
            
            // Reset stats during loading
            document.getElementById('completion-rate').textContent = '—';
            document.getElementById('missing-students').textContent = '—';
            document.getElementById('total-assignments').textContent = '—';
            document.getElementById('problematic-assignment').textContent = '—';
        }

        // Function to calculate and display statistics
        function calculateAndDisplayStats(lines, assignmentHeaders) {
            const studentData = lines.slice(2);
            const totalStudents = studentData.filter(line => line.split(',')[0].trim()).length;
            const totalAssignments = assignmentHeaders.length;
            
            if (totalStudents === 0 || totalAssignments === 0) {
                // Reset stats if no data
                document.getElementById('completion-rate').textContent = '—';
                document.getElementById('missing-students').textContent = '—';
                document.getElementById('total-assignments').textContent = '—';
                document.getElementById('problematic-assignment').textContent = '—';
                return;
            }

            // Calculate completion statistics
            let totalPossibleCompletions = totalStudents * totalAssignments;
            let actualCompletions = 0;
            let studentsWithMissingWork = 0;
            let assignmentMissingCounts = new Array(totalAssignments).fill(0);

            studentData.forEach(line => {
                const columns = line.split(',');
                const studentName = columns[0].trim();
                if (!studentName) return;

                let studentHasMissing = false;
                
                assignmentHeaders.forEach((_, index) => {
                    const statusKey = (columns[index + 1] || '').trim();
                    
                    if (statusKey === 'c' || statusKey === 'AS' || statusKey === 'MS') {
                        actualCompletions++;
                    } else if (statusKey === 'm') {
                        studentHasMissing = true;
                        assignmentMissingCounts[index]++;
                    } else if (statusKey === 'i') {
                        studentHasMissing = true;
                    }
                });

                if (studentHasMissing) {
                    studentsWithMissingWork++;
                }
            });

            // Calculate completion rate
            const completionRate = totalPossibleCompletions > 0 
                ? Math.round((actualCompletions / totalPossibleCompletions) * 100) 
                : 0;

            // Find most problematic assignment
            let maxMissing = 0;
            let problematicAssignmentIndex = 0;
            assignmentMissingCounts.forEach((count, index) => {
                if (count > maxMissing) {
                    maxMissing = count;
                    problematicAssignmentIndex = index;
                }
            });

            const problematicAssignment = maxMissing > 0 
                ? assignmentHeaders[problematicAssignmentIndex].trim()
                : 'None';

            // Update the stats display
            document.getElementById('completion-rate').textContent = `${completionRate}%`;
            document.getElementById('missing-students').textContent = `${studentsWithMissingWork}/${totalStudents}`;
            document.getElementById('total-assignments').textContent = totalAssignments.toString();
            document.getElementById('problematic-assignment').textContent = problematicAssignment;
        }

        async function parseAndRender() {
            const selector = document.getElementById('class-selector');
            const selectedValue = selector.value;
            
            // Show loading state
            showLoadingState();
            
            // Fetch data from Google Sheets
            const rawData = await fetchCsvData(selectedValue);
            if (!rawData) return;

            const lines = rawData.trim().split('\n');
            const assignmentHeaders = lines[0].split(',').slice(1);
            const dateHeaders = lines[1].split(',').slice(1);
            const studentData = lines.slice(2);

            let tableHTML = `<table class="min-w-full divide-y divide-gray-200">`;

            // Table Head
            tableHTML += `<thead class="bg-gray-50"><tr>`;
            tableHTML += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>`;
            assignmentHeaders.forEach((header, index) => {
                tableHTML += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    <div>${header.trim()}</div>
                    <div class="font-normal text-gray-400">${dateHeaders[index] ? dateHeaders[index].trim() : ''}</div>
                </th>`;
            });
            tableHTML += `</tr></thead>`;

            // Table Body
            tableHTML += `<tbody class="bg-white divide-y divide-gray-200">`;
            studentData.forEach(line => {
                const columns = line.split(',');
                const studentName = columns[0].trim();
                if (!studentName) return; // Skip empty lines

                tableHTML += `<tr>`;
                tableHTML += `<td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${studentName}</td>`;
                
                assignmentHeaders.forEach((_, index) => {
                    const statusKey = (columns[index + 1] || '').trim();
                    
                    // Handle empty cells - show empty cell instead of "Missing"
                    if (!statusKey) {
                        tableHTML += `<td class="px-6 py-4 whitespace-nowrap text-gray-400">—</td>`;
                        return;
                    }
                    
                    const status = statusMap[statusKey] || statusMap['default'];
                    const colors = colorClasses[status.color];

                    tableHTML += `<td class="px-6 py-4 whitespace-nowrap">`;
                    tableHTML += `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${colors.bg} ${colors.text}">`;
                    tableHTML += `<svg class="w-5 h-5 mr-2 ${colors.icon}" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="${status.icon}"></path></svg>`;
                    tableHTML += status.text;
                    tableHTML += `</span></td>`;
                });

                tableHTML += `</tr>`;
            });
            tableHTML += `</tbody></table>`;

            document.getElementById('table-container').innerHTML = tableHTML;
            
            // Calculate and display statistics
            calculateAndDisplayStats(lines, assignmentHeaders);
        }
        
        function populateLegend() {
            const legendContainer = document.getElementById('legend');
            const displayedStatuses = new Set();
            let legendHTML = '';

            Object.values(statusMap).forEach(status => {
                if (status.text === 'Missing' && displayedStatuses.has('Missing')) return;

                const colors = colorClasses[status.color];
                legendHTML += `
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-1.5 ${colors.icon}" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="${status.icon}"></path></svg>
                        <span class="text-sm text-gray-600">${status.text}</span>
                    </div>`;
                displayedStatuses.add(status.text);
            });
            legendContainer.innerHTML = legendHTML;
        }


        document.addEventListener('DOMContentLoaded', async () => {
            const selector = document.getElementById('class-selector');
            selector.addEventListener('change', parseAndRender);
            
            // Set generation date
            document.getElementById('generation-date').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });

            // Initial render
            await parseAndRender();
            populateLegend();
        });

    </script>
</body>
</html>
